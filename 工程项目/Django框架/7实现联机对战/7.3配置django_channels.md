1. 安装`channels_redis`：
    `pip install channels_redis==3.3.1`

2. 配置`app/asgi.py` 

  ```py
  import os
  
  from channels.auth import AuthMiddlewareStack
  from channels.routing import ProtocolTypeRouter, URLRouter
  from django.core.asgi import get_asgi_application
  from game.routing import websocket_urlpatterns
  
  os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app.settings')
  
  application = ProtocolTypeRouter({
      "http": get_asgi_application(),
      "websocket": AuthMiddlewareStack(URLRouter(websocket_urlpatterns))
  })
  ```

3. 配置`app/settings.py`

  在`INSTALLED_APPS`中添加`channels`，添加后如下所示：

  ```py
  INSTALLED_APPS = [ 
      'channels',
      'game.apps.GameConfig',
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
  ]
  ```

  然后在文件末尾添加：

  ```py
  ASGI_APPLICATION = 'app.asgi.application'
  CHANNEL_LAYERS = {
      "default": {
          "BACKEND": "channels_redis.core.RedisChannelLayer",
          "CONFIG": {
              "hosts": [("127.0.0.1", 6379)],
          },
      },
  }
  ```

4. 配置`game/routing.py`

  这一部分的作用相当于`http`的`urls`。
  ```py
  from django.urls import path
  
  websocket_urlpatterns = [
  ]
  ```

5.  编写`game/consumers`

  这一部分的作用相当于`http`的`views`。

  ```py
  from channels.generic.websocket import AsyncWebsocketConsumer
  import json
  
  class MultiPlayer(AsyncWebsocketConsumer):
      async def connect(self):
          await self.accept()
          print('accept')
  
          self.room_name = "room"
          await self.channel_layer.group_add(self.room_name, self.channel_name)
  
      async def disconnect(self, close_code):
          print('disconnect')
          await self.channel_layer.group_discard(self.room_name, self.channel_name)
  
  
      async def receive(self, text_data):
          data = json.loads(text_data)
          print(data)
  ```

6. 启动`django_channels`

  在`~/app`目录下执行：

  `daphne -b 0.0.0.0 -p 5015 app.asgi:application` 

---

### 操作

#### 统一长宽

统一实现画布等比例 16:9

```sh
cd ~/app/game/static/js/src/playground/  # 操作界面
vim zbase.js  # 归一化处理
cd ~/app/game/static/js/src/playground/game_map
vim zbase.js  # 修改黑框大小，随着拖拽放大缩小
cd  ~/app/game/static/css # 地图居中, 外框颜色修改
vim game.css  

git commit -m "canvas unification"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/287251be15b9ddc9c398634accce03b9297b4922) [Github-diff](https://github.com/hueryan/django-first/commit/287251be15b9ddc9c398634accce03b9297b4922) 

统一Player相对位置、大小

```sh
cd ~/app/game/static/js/src/playground/
vim zbase.js  # 初始化开始，变成相对值
vim player/zbase.js
vim skill/fireball/zbase.js
vim particle/zbase.js

git commit -m "player_skill_particle unification"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/28116b15a46ea74bad61ccb2a0fb92c9fb2e9dac) [Github-diff](https://github.com/hueryan/django-first/commit/28116b15a46ea74bad61ccb2a0fb92c9fb2e9dac) 

#### 增加“联机对战”模式

```sh
cd ~/app/game/static/js/src/menu
vim zbase.js  # 修改菜单
cd ~/app/game/static/js/src/playground/
vim zbase.js  # 通过模式判断
vim player/zbase.js  # 修改了判断角色逻辑

git commit -m "add muti mode"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/c9b18d2d2a33c645e115ce45c9d3d2e165a1187c) [Github-diff](https://github.com/hueryan/django-first/commit/c9b18d2d2a33c645e115ce45c9d3d2e165a1187c) 

#### 配置django_channels

```
pip install channels_redis==3.3.1
```

#### 配置文件

```sh
cd ~/app/app
vim asgi.py  # ----------------------
vim settings.py  # ----------------

cd ~/app/game
vim routing.py  # ----------------------
mkdir consumers  # 作为游戏终端服务器
cd consumers
touch __init__.py
mkdir multiplayer
cd multiplayer
touch __init__.py
vim index.py  #--------------
```

```py
import os

from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter
from django.core.asgi import get_asgi_application
from game.routing import websocket_urlpatterns

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'app.settings')

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(URLRouter(websocket_urlpatterns))
})
```

```py
INSTALLED_APPS = [
    'channels',  # 增加
]


# 末尾增加
ASGI_APPLICATION = 'app.asgi.application'
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [("127.0.0.1", 6379)],
        },
    },
}
```

```py
from django.urls import path

websocket_urlpatterns = [
]
```

```py
from channels.generic.websocket import AsyncWebsocketConsumer
import json

class MultiPlayer(AsyncWebsocketConsumer):
    async def connect(self):
        await self.accept()
        print('accept')

        self.room_name = "room"
        await self.channel_layer.group_add(self.room_name, self.channel_name)

    async def disconnect(self, close_code):
        print('disconnect')
        await self.channel_layer.group_discard(self.room_name, self.channel_name)


    async def receive(self, text_data):
        data = json.loads(text_data)
        print(data)
```

```sh
git commit -m "configure django_channels"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/3572417f1f113952706c374d672ad5cee841d50d) [Github-diff](https://github.com/hueryan/django-first/commit/3572417f1f113952706c374d672ad5cee841d50d) 

#### 创建wss

```sh
cd ~/app/game/static/js/src/playground
mkdir socket/multiplayer  # 联机对战
cd socket/multiplayer
vim zbase.js

vim ~/app/game/routing.py  # 路由
cd ~/app/game/static/js/src/playground
vim zbase.js

git commit -m "create wss"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/840865c9e47c5d0e0735abefe6adf7bd273fa02d) [Github-diff](https://github.com/hueryan/django-first/commit/840865c9e47c5d0e0735abefe6adf7bd273fa02d) 

#### 创建用户唯一编号、并且将自己的uuid广播

```sh
cd ~/app/game/static/js/src/playground
vim a_game_object/zbase.js
vim zbase.js

git commit -m "Create a unique user identifier broadcast UUID"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/3462bcdf3671e8e904858fe7d67c129a461031f0) [Github-diff](https://github.com/hueryan/django-first/commit/3462bcdf3671e8e904858fe7d67c129a461031f0) 

#### 同步玩家同框

存储到redis中，设置房间、人数上限room_0...room_1...room_2

```sh
cd ~/app/app
vim settings.py  # 通用配置、设置玩家上限
cd ~/app/game/consumers/multiplayer
vim index.py  # 增加settings的配置信息
cd ~/app/game/static/js/src/playground  
vim zbase.js  # 单独事件创建玩家
vim socket/multiplayer/zbase.js  # 实现刚传参的函数，向后台发送请求
cd ~/app/game/consumers/multiplayer
vim index.py  # 根据event做路由
cd ~/app/game/static/js/src/playground/player
vim zbase.js

git commit -m "Player in the same playground"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/e178470d26ca9de20cde6aad3af2ce6453ca9929) [Github-diff](https://github.com/hueryan/django-first/commit/e178470d26ca9de20cde6aad3af2ce6453ca9929)  



