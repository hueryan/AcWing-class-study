![1_1ddf070e4d-weboauth2](./assets/1_1ddf070e4d-weboauth2.png) 

**第一步：申请授权码 `code`** 

[请求地址](https://www.acwing.com/third_party/api/oauth2/web/authorize/) 

参考示例：

```sh
请求方法：GET
https://www.acwing.com/third_party/api/oauth2/web/authorize/?appid=APPID&redirect_uri=REDIRECT_URI&scope=SCOPE&state=STATE
```



**参数说明**

| 参数         | 是否必填 | 说明                                                         |
| ------------ | -------- | ------------------------------------------------------------ |
| appid        | 是       | 应用的唯一id，可以在AcWing编辑AcApp的界面里看到              |
| redirect_uri | 是       | 接收授权码的地址。需要用对链接进行编码：Python3中使用urllib.parse.quote；Java中使用URLEncoder.encode |
| scope        | 是       | 申请授权的范围。目前只需填userinfo                           |
| state        | 否       | 用于判断请求和回调的一致性，授权成功后后原样返回。该参数可用于防止csrf攻击（跨站请求伪造攻击），建议第三方带上该参数，可设置为简单的随机数（如果是将第三方授权登录绑定到现有账号上，那么推荐用随机数 + user_id作为state的值，可以有效防止CSRF攻击） |

**返回说明**

用户同意授权后会重定向到`redirect_uri`，返回参数为`code`和`state`。链接格式如下：

```
redirect_uri?code=CODE&state=STATE
```

如果用户拒绝授权，则不会发生重定向。

---

**第二步 申请授权令牌`access_token`和用户的`openid`** 

[请求地址](https://www.acwing.com/third_party/api/oauth2/access_token/)

参考示例：

```sh
请求方法：GET
https://www.acwing.com/third_party/api/oauth2/access_token/?appid=APPID&secret=APPSECRET&code=CODE
```

**参数说明**

| 参数   | 是否必须 | 说明                                            |
| ------ | -------- | ----------------------------------------------- |
| appid  | 是       | 应用的唯一id，可以在AcWing编辑AcApp的界面里看到 |
| secret | 是       | 应用的秘钥，可以在AcWing编辑AcApp的界面里看到   |
| code   | 是       | 第一步中获取的授权码                            |

**返回说明**
申请成功示例：

```sh
{ 
    "access_token": "ACCESS_TOKEN", 
    "expires_in": 7200, 
    "refresh_token": "REFRESH_TOKEN",
    "openid": "OPENID", 
    "scope": "SCOPE",
}
```

申请失败示例：

```sh
{
    "errcode": 40001,
    "errmsg": "code expired",  # 授权码过期
}
```

**返回参数说明**

| 参数          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| access_token  | 授权令牌，有效期2小时                                        |
| expires_in    | 授权令牌还有多久过期，单位（秒）                             |
| refresh_token | 用于刷新access_token的令牌，有效期30天                       |
| openid        | 用户的id。每个AcWing用户在每个acapp中授权的openid是唯一的,可用于识别用户。 |
| scope         | 用户授权的范围。目前范围为userinfo，包括用户名、头像         |

**刷新access_token的有效期**

`access_token`的有效期为2小时，时间较短。`refresh_token`的有效期为30天，可用于刷新`access_token`。刷新结果有两种：

1. 如果`access_token`已过期，则生成一个新的`access_token`。
2. 如果`access_token`未过期，则将当前的`access_token`的有效期延长为2小时。

参考示例：

```sh
请求方法：GET
https://www.acwing.com/third_party/api/oauth2/refresh_token/?appid=APPID&refresh_token=REFRESH_TOKEN
```

返回结果的格式与申请`access_token`相同。

---

**第三步 申请用户信息**
[请求地址](https://www.acwing.com/third_party/api/meta/identity/getinfo/)

参考示例：

```sh
请求方法：GET
https://www.acwing.com/third_party/api/meta/identity/getinfo/?access_token=ACCESS_TOKEN&openid=OPENID
```

**参数说明**

| 参数         | 是否必须 | 说明                     |
| ------------ | -------- | ------------------------ |
| access_token | 是       | 第二步中获取的授权令牌   |
| openid       | 是       | 第二步中获取的用户openid |

**返回说明**

申请成功示例：

```sh
{
    'username': "USERNAME",
    'photo': "https:cdn.acwing.com/xxxxx"
}
```

申请失败示例：

```sh
{
    'errcode': "40004",
    'errmsg': "access_token expired"  # 授权令牌过期
}
```

---

### 操作

在Player增加`openid` 

```sh
cd ~/app/game/models/player
vim player.py  # 增加openid字段
cd ~/app  # 更新数据库
python3 manage.py makemigrations
python3 manage.py migrate
uwsgi --ini scripts/uwsgi.ini # 重启服务器
ip/admin/game/player  # 浏览器访问
```

[gitee源码](https://gitee.com/hueryan/django-first/tree/9b22239240e8b21d607f4c25a891990d0336aa29)  [GitHub-diff](https://github.com/hueryan/django-first/commit/9b22239240e8b21d607f4c25a891990d0336aa29) 

**实现第一步：接受用户请求，向Acwing发送请求**

```sh
# 后端
cd ~/app/game/views/settings
mkdir acwing
cd acwing
touch __init__.py
mkdir web acapp
touch web/__init__.py acapp/__init__.py
cd web 
vim apply_code.py  # 发起请求函数
vim receive_code.py  # 创建新的API接收请求
cd ~/app/game/urls/settings
mkdir acwing
touch acwing/__init__.py
vim acwing/index.py
cd ~/app/game/urls/settings
vim index.py  # 更新路由

# 前端
cd ~/app/game/static/js/src/settings/
vim zbase.js

git commit -m "Accept user requests and send them to Acwing for code"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/5e3b5a6dd765f9cf36932aca5414ee4c8c660e0e) [Gitee-diff](https://github.com/hueryan/django-first/commit/5e3b5a6dd765f9cf36932aca5414ee4c8c660e0e) 

---

**实现第二步 申请授权令牌`access_token`和用户的`openid`** 

```sh
cd ~/app/game/views/settings/web
vim receive_code.py 
git commit -m "get access_token & openid"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/026299a919f7598cf4f27b776a8ad015fe6acb8a) [Github-diff](https://github.com/hueryan/django-first/commit/026299a919f7598cf4f27b776a8ad015fe6acb8a) 

---

**实现第三步 申请用户信息**

```sh
cd ~/app/game/views/settings/web
vim receive_code.py 
git commit -m "Request user information"
```

[Gitee-源码](https://gitee.com/hueryan/django-first/tree/2e5651c30bcfa4ab016742c96421935e0eaa849b) [Github-diff](https://github.com/hueryan/django-first/commit/2e5651c30bcfa4ab016742c96421935e0eaa849b) 

