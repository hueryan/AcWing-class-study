[官网配置](https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html) 

1. 安装

   ```sh
   pip install djangorestframework-simplejwt==5.1
   ```

   在`settings.py` 添加

   ```py
   INSTALLED_APPS = [
       ...
       'rest_framework_simplejwt',
       ...
   ]
   
   REST_FRAMEWORK = {
       ...
       'DEFAULT_AUTHENTICATION_CLASSES': (
           ...
           'rest_framework_simplejwt.authentication.JWTAuthentication',
       )
       ...
   }
   ```

2. 配置

   在`settings.py`中添加：

   ```py
   from datetime import timedelta
   ...
   
   SIMPLE_JWT = {
       'ACCESS_TOKEN_LIFETIME': timedelta(minutes=5),
       'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
       'ROTATE_REFRESH_TOKENS': False,
       'BLACKLIST_AFTER_ROTATION': False,
       'UPDATE_LAST_LOGIN': False,
   
       'ALGORITHM': 'HS256',
       'SIGNING_KEY': SECRET_KEY,
       'VERIFYING_KEY': None,
       'AUDIENCE': None,
       'ISSUER': None,
       'JWK_URL': None,
       'LEEWAY': 0,
   
       'AUTH_HEADER_TYPES': ('Bearer',),
       'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
       'USER_ID_FIELD': 'id',
       'USER_ID_CLAIM': 'user_id',
       'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',
   
       'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
       'TOKEN_TYPE_CLAIM': 'token_type',
       'TOKEN_USER_CLASS': 'rest_framework_simplejwt.models.TokenUser',
   
       'JTI_CLAIM': 'jti',
   
       'SLIDING_TOKEN_REFRESH_EXP_CLAIM': 'refresh_exp',
       'SLIDING_TOKEN_LIFETIME': timedelta(minutes=5),
       'SLIDING_TOKEN_REFRESH_LIFETIME': timedelta(days=1),
   }
   ```

3. 添加获取jwt和刷新jwt的路由

   `~/app/game/urls/settings/index.py`

   ```py
   from rest_framework_simplejwt.views import (
       TokenObtainPairView,
       TokenRefreshView,
   )
   
   urlpatterns = [
       ...
       path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
       path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
       ...
   ]
   ```

4. 手动获取jwt

   `~/app/game/views/settings/acwing/web/receive_code.py` 

   ```py
   from rest_framework_simplejwt.tokens import RefreshToken
   
   def get_tokens_for_user(user):
       refresh = RefreshToken.for_user(user)
   
       return {
           'refresh': str(refresh),
           'access': str(refresh.access_token),
       }
   ```

5. 将jwt验证集成到Django Channels中

   创建文件`~/app/game/channelsmiddleware.py`

   ```py
   """General web socket middlewares
   """
   
   from channels.db import database_sync_to_async
   from django.contrib.auth import get_user_model
   from django.contrib.auth.models import AnonymousUser
   from rest_framework_simplejwt.exceptions import InvalidToken, TokenError
   from rest_framework_simplejwt.tokens import UntypedToken
   from rest_framework_simplejwt.authentication import JWTTokenUserAuthentication
   from channels.middleware import BaseMiddleware
   from channels.auth import AuthMiddlewareStack
   from django.db import close_old_connections
   from urllib.parse import parse_qs
   from jwt import decode as jwt_decode
   from django.conf import settings
   @database_sync_to_async
   def get_user(validated_token):
       try:
           user = get_user_model().objects.get(id=validated_token["user_id"])
           # return get_user_model().objects.get(id=toke_id)
           return user
   
       except:
           return AnonymousUser()
   
   
   
   class JwtAuthMiddleware(BaseMiddleware):
       def __init__(self, inner):
           self.inner = inner
   
       async def __call__(self, scope, receive, send):
          # Close old database connections to prevent usage of timed out connections
           close_old_connections()
   
           # Try to authenticate the user
           try:
               # Get the token
               token = parse_qs(scope["query_string"].decode("utf8"))["token"][0]
   
               # This will automatically validate the token and raise an error if token is invalid
               UntypedToken(token)
           except:
               # Token is invalid
   
               scope["user"] = AnonymousUser()
           else:
               #  Then token is valid, decode it
               decoded_data = jwt_decode(token, settings.SIMPLE_JWT["SIGNING_KEY"], algorithms=["HS256"])
   
               # Get the user using ID
               scope["user"] = await get_user(validated_token=decoded_data)
           return await super().__call__(scope, receive, send)
   
   
   def JwtAuthMiddlewareStack(inner):
       return JwtAuthMiddleware(AuthMiddlewareStack(inner))
   ```

   

